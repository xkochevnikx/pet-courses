services:
  web:
    image: node:20-bookworm-slim
    container_name: web-dev
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ./:/app
      - /app/node_modules
    env_file: .env
    environment:
      # S3/MinIO
      S3_ENDPOINT: http://minio:9000
      S3_REGION: us-east-1
      S3_ACCESS_KEY_ID: ${MINIO_ROOT_USER}
      S3_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD}
      S3_BUCKET: ${S3_BUCKET}
      S3_PUBLIC_URL: http://localhost:9000/images
      MINIO_INTERNAL_BASE: http://minio:9000/images

      # App
      NEXTAUTH_URL: http://localhost:3000
      PORT: 3000

      # Hot reload
      WATCHPACK_POLLING: "true"
      CHOKIDAR_USEPOLLING: "true"
    ports:
      - "3000:3000"
    depends_on:
      db:
        condition: service_healthy
      dbfix:
        condition: service_completed_successfully
      minio:
        condition: service_healthy
      createbuckets:
        condition: service_completed_successfully

    command: >
      sh -lc "
        set -eu;

        echo '[web-dev] deps...';
        if [ ! -f node_modules/.bin/prisma ]; then
          echo '[web-dev] installing deps (prisma missing)...';
          if [ -f package-lock.json ]; then
            npm ci --no-audit --no-fund;
          else
            npm install --no-audit --no-fund;
          fi;
        fi;

        echo '[web-dev] prisma generate...';
        npx --no-install prisma generate;

        echo '[web-dev] Prisma migrate (retry)...';
        ok=0;
        for i in 1 2 3 4 5 6 7 8 9 10; do
          if npx --no-install prisma migrate deploy; then ok=1; break; fi;
          echo \"[web-dev] migrate failed, retry ${i}/10 ...\";
          sleep 2;
        done;

        if [ \"${ok}\" != \"1\" ]; then
          echo '[web-dev] migrate did not succeed, trying db push...';
          npx --no-install prisma db push;
        fi;

        echo '[web-dev] start dev server';
        exec npm run dev
      "
